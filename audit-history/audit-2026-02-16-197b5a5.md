# Audit Report — 2026-02-16

## Commit: 197b5a5

## Summary of Changes

Major refactor covering undo/redo system rearchitecture, UI polish, and chat system rewrite.

### Undo/Redo System (server-side JSONL manipulation)
- **server/api-plugin.ts**: Added `append-jsonl` endpoint for redo operations. File watcher now handles truncation gracefully (resets offset when file shrinks).
- **src/hooks/useUndoRedo.ts**: Complete rewrite — undo truncates JSONL and archives turns into branches; redo appends archived JSONL lines back. Added ghost turn rendering, partial redo support, child branch collection/splitting.
- **src/lib/undo-engine.ts**: New helpers `collectChildBranches`, `splitChildBranches`; updated `createBranch` to accept child branches.
- **src/hooks/useSessionState.ts**: Added `RELOAD_SESSION_CONTENT` action; removed `SET_UNDO_TURN_INDEX`.
- **src/hooks/useLiveSession.ts**: SSE reconnects on `rawText` change to handle truncation.

### Chat System (HTTP API)
- **src/hooks/usePtyChat.ts**: Replaced PTY terminal-based chat with HTTP `POST /api/send-message`. Removed terminal manager dependency. Added permissions support.

### UI Components
- **src/components/ConversationTimeline.tsx**: Ghost turns with "redo to here" buttons. Compaction summary markers. Removed `isUndone` prop.
- **src/components/SessionBrowser.tsx**: Sidebar layout restructured (LiveSessions top, Browse/Teams bottom). Removed turn navigator and tool call index (moved to StatsPanel). Added new session button, search clear button.
- **src/components/StatsPanel.tsx**: Absorbed turn navigator and tool call index from SessionBrowser. Added search bar and permissions panel slot.
- **src/components/ChatInput.tsx**: Permission mode badge, glass styling.
- **src/components/UndoRedoBar.tsx**: Simplified to `redoTurnCount` / `onRedoAll`.
- **src/components/TurnContextMenu.tsx**: Simplified — always shows "Restore to this point".
- **src/components/timeline/ThinkingBlock.tsx**: Removed avatar wrapper, fixed indentation.
- **src/components/timeline/ToolCallCard.tsx**: Added timestamps to tool call headers.
- **src/components/ui/scroll-area.tsx**: Added `overflow-hidden` to root.

### New Files
- `src/components/Dashboard.tsx` — Dashboard component
- `src/components/PermissionsPanel.tsx` — Permissions panel UI
- `src/hooks/useChatScroll.ts` — Chat scroll management
- `src/hooks/useKeyboardShortcuts.ts` — Keyboard shortcut bindings
- `src/hooks/usePermissions.ts` — Permission state management
- `src/hooks/useSessionActions.ts` — Session action helpers
- `src/lib/permissions.ts` — Permission types and utilities

### Styling
- **src/index.css**: Added glass effect, card-glow, live-pulse, skeleton shimmer, fade-in animation, desktop scrollbar styling, gradient border utilities.

### Parser
- **src/lib/parser.ts**: Added `SummaryMessage` support, compaction summary building.
- **src/lib/types.ts**: New types for compaction, summary messages, tool call timestamps.

## Documentation Status
- Existing plan docs in `docs/plans/` remain accurate for design intent
- No user-facing README changes needed (internal tooling)

## Issues Found During Review (Fixed)
1. Removed dead `splice-jsonl` endpoint from server
2. Fixed indentation in ThinkingBlock.tsx
3. Removed unused `onJumpToTurn` prop from SessionBrowser
4. Added TODO comment for partial-failure risk in undo flow
